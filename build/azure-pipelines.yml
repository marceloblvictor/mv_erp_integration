trigger:
  branches:
    include:
      - main

variables:
  imageName: mygoapi
  containerName: mygoapi
  resourceGroup: my-goapi-rg
  location: spaincentral

stages:
- stage: BuildAndPush
  displayName: Build and Push Docker Image
  jobs:
  - job: DockerBuildPush
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - checkout: self

    - task: Docker@2
      displayName: Build and Push
      inputs:
        containerRegistry: 'YOUR_CONTAINER_REGISTRY_SERVICE_CONNECTION'
        repository: $(imageName)
        command: 'buildAndPush'
        Dockerfile: '**/Dockerfile'
        tags: |
          latest

- stage: DeployTerraform
  displayName: Deploy Infrastructure with Terraform
  jobs:
  - job: TerraformApply
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - checkout: self

    - task: AzureCLI@2
      displayName: Terraform Init & Apply
      inputs:
        azureSubscription: 'azure-connection'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        workingDirectory: 'terraform'
        inlineScript: |
          az --version
          terraform init
          terraform plan -out=tfplan -input=false -var "resource_group_name=$(resourceGroup)" -var "container_name=$(containerName)" -var "image_name=<your-acr-name>.azurecr.io/$(imageName):latest"
          terraform apply -input=false tfplan
